<?php
session_start();
require_once 'config/config.php';
require_once BASE_PATH . '/includes/auth_validate.php';
$search_str = filter_input(INPUT_GET, 'search_str');
$pagelimit = 15;

$page = filter_input(INPUT_GET, 'page');
if (!$page) {
    $page = 1;
}


$db = getDbInstance();

$select = array('Channel_id', 'Channel_name');

if ($search_str) {
    $db->where('Channel_name', '%' . $search_str . '%', 'like');
}

$db->pageLimit = $pagelimit;

$rows = $db->arraybuilder()->paginate('timetravel_tab', $page, $select);

$total_pages = $db->totalPages;
?>
<?php

$folder_path = "images/video"; 
   
// List of name of files inside 
// specified folder 
$files = glob($folder_path.'/*');  
   
// Deleting all the files in the list 
foreach($files as $file) { 
   
    if(is_file($file))  
    
        // Delete the given file 
        unlink($file);  
} 
        
        


             $link = mysqli_connect('localhost', 'root', 'Qwerty@1234');
        
        if (!$link) {
            echo "Error: Unable to connect to MySQL." . PHP_EOL;
            echo "Debugging errno: " . mysqli_connect_errno() . PHP_EOL;
            echo "Debugging error: " . mysqli_connect_error() . PHP_EOL;
            exit;
        }

        
        $db_selected = mysqli_select_db( $link,'SENTINELX' );
            
        if (!$db_selected)
        {
            echo "Debugging errno: " . mysqli_connect_errno() . PHP_EOL;
            echo "Debugging error: " . mysqli_connect_error() . PHP_EOL;   
            echo "<script type='text/javascript'>alert('" . mysqli_connect_errno() . "');</script>";
                 
            exit;
        }
if(isset($_GET['SeqNo'])){
                $seq= $_GET['SeqNo'];
                // echo $seq;
            
$sql1 = "SELECT * FROM timetravel_tab where Channel_id ='".$seq."'";
$result1=mysqli_query($link,$sql1);
while ($row1 = mysqli_fetch_array($result1, MYSQLI_NUM)){
  $channel = $row1[1];
  $time_grp = $row1[3];
  $event_grp = $row1[4];
  $status = $row1[5];
  // echo $time_grp;
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
$count = 0;

if($status==1){


          $event_array = array();

          $sql3 = "SELECT Data FROM eventgroups WHERE Name='".$event_grp."'";
          $result3=mysqli_query($link,$sql3);
          while ($row3 = mysqli_fetch_array($result3, MYSQLI_NUM)){
            $comma_split = explode(',', $row3[0]);
            for($k=0; $k<sizeof($comma_split); $k++){
              $hyphen_split = explode('-', $comma_split[$k]);
              // print_r($hyphen_split);
              for($j=0; $j<sizeof($hyphen_split)-1; $j++){

                if($hyphen_split[1] == 1){
                  array_push($event_array, $hyphen_split[0]);
                  $count = 1;

                  
                  
                }
              }

            }
          }
     
}

$time = array();
if($count == 1){
  for($i=0; $i<sizeof($event_array); $i++){
    $sql = "SELECT unixtime FROM dl_event_tab1 WHERE channel_id = '".$seq."' and Event_id='".$event_array[$i]."'";
    $result=mysqli_query($link,$sql);
    while ($row = mysqli_fetch_array($result, MYSQLI_NUM)){
      array_push($time, $row[0]);
      // print_r($time);
      $count=2;
    }
  }
// print_r($time);
      
if($count==2){ 

      $sql4 = "SELECT TData from time_groups where TName='".$time_grp."'";
      $result1=mysqli_query($link,$sql4);
      while ($row1 = mysqli_fetch_array($result1, MYSQLI_NUM)){
        $time_data = $row1[0];
        // print_r($time_data);
        $time_data = explode(',', $time_data);
         // print_r($time_data);

        for($i=0; $i<sizeof($time_data)-1; $i++){
          
          $final_time_data = explode('-', $time_data[$i]);
          // print_r($final_time_data);
          if($final_time_data[0] != '' and $final_time_data[1] != ''){
            
            // echo "start time is ". $start_time.'<br/>';
            for($j=1; $j<=30; $j++){
            $date = date('Y-m-d', strtotime('today - '.$j.' days'));
            $start_date = ''.$date.' '.$final_time_data[0].'';
            $end_date = ''.$date.' '.$final_time_data[1].'';
            $start_time = strtotime($start_date);
            $end_time = strtotime($end_date);
             // echo "date.".$date,"start".$start_time,"end".$end_time;

            for($k=0; $k<sizeof($time); $k++){
              // echo $time[$j];
            if($start_time<$time[$k] and $time[$k]<$end_time){
              $time_arg = $time[$k];
              // echo "unixtime is".$time_arg;
              // echo "success";
              exec("python3 image.py '".$time_arg."' 100 '".$seq."' 2>&1",$output);
              // print_r($output);
          }
        }
           
          }
          
             
            // echo "end time is ". $end_time.'<br/>';
      //       echo $time.'<br/>';
            
            }
           
            // $location = $output1[0];

            
       }
        exec("python3 concatenate.py '".$seq."' ",$output);

            
      }
  
  }

}
}

?>


<?php include BASE_PATH . '/includes/header.php'; ?>
<!-- Main container -->
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-6">
            <h1 class="page-header">Time travel View</h1>
        </div>
    </div>
    <?php include BASE_PATH . '/includes/flash_messages.php'; ?>

    <!-- Filters -->
    <div class="well text-center filter-form">
        <form class="form form-inline" action="">
            <label for="input_search">Search</label>
            <input type="text" class="form-control" id="input_search" name="search_str" value="<?php echo htmlspecialchars($search_str, ENT_QUOTES, 'UTF-8'); ?>">
            <input type="submit" value="Go" class="btn btn-primary">
        </form>
    </div>
    <hr>
    <!-- //Filters -->

    <!-- Table -->

   
    <table class="table table-striped table-bordered table-condensed">
        <thead>
            <tr>
                <th>ID</th>
                <th>Channel name</th>
                
            </tr>
        </thead>
        <tbody>
            <?php foreach ($rows as $row): ?>
                
              
            <tr>
               
                <td><?php echo $row['Channel_id']; ?></td>
                <td><?php echo $row['Channel_name']; ?>   <a href=timetravel_channel1.php?SeqNo=<?php echo $row['Channel_id']; ?>>GenerateVideo</a>  <a href="#" onclick="MyWindow=window.open('video.php?SeqNo=<?php echo $row['Channel_id']?>','MyWindow',width=320,height=240); return false;">Viewvideo</a> </td>

              
            </tr>

           
            
            <?php endforeach; ?>
        </tbody>
    </table>
    <!-- //Table -->

    <!-- Pagination -->
    <div class="text-center">
        <!--<?php echo paginationLinks($page, $total_pages, 'customers.php'); ?>
    </div>
     //Pagination -->
</div>
<!-- //Main container -->
<?php include BASE_PATH . '/includes/footer.php'; ?>
